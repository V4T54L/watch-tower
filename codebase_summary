{
  "cmd/consumer/main.go": "- File Path: `cmd/consumer/main.go`\n- High-Level Purpose: This file serves as the entry point for the log consumer worker service. It initializes core components like configuration and logging, and outlines the steps for starting the consumer logic.\n- Definitions in the File:\n  - Functions:\n    - `main()`: Public function.\n      - Description: The main function of the consumer worker. It loads application configuration, initializes a structured logger, and logs startup and shutdown messages. It includes TODOs for connecting to Redis and PostgreSQL, starting the consumer group processing loop, and handling graceful shutdown.\n- Notable Patterns or Logic:\n  - Application startup sequence: Loads configuration, initializes logger.\n  - Graceful shutdown placeholder.",
  "cmd/ingest/main.go": "- File Path: `cmd/ingest/main.go`\n- High-Level Purpose: This file serves as the entry point for the log ingest gateway service. It initializes core components like configuration and logging, and outlines the steps for starting the ingest server.\n- Definitions in the File:\n  - Functions:\n    - `main()`: Public function.\n      - Description: The main function of the ingest gateway. It loads application configuration, initializes a structured logger, and logs startup and shutdown messages. It includes TODOs for initializing repositories, use cases, setting up HTTP routing, starting the server, and handling graceful shutdown.\n- Notable Patterns or Logic:\n  - Application startup sequence: Loads configuration, initializes logger.\n  - Graceful shutdown placeholder.\n",
  "go.mod": "- File Path: `go.mod`\n- High-Level Purpose: This file defines the Go module for the `log-ingestor` project, specifying its module path, Go version, and direct external dependencies.\n- Definitions in the File:\n  - Variables / Constants:\n    - `module`: `github.com/user/log-ingestor` (module path).\n    - `go`: `1.21` (Go language version requirement).\n  - Dependencies:\n    - `github.com/caarlos0/env/v10 v10.0.0`: Required for parsing environment variables into structs.\n    - `github.com/joho/godotenv v1.5.1`: Required for loading `.env` files.\n- Notable Patterns or Logic:\n  - Standard Go module definition.\n",
  "internal/adapter/api/middleware/auth.go": "- File Path: `internal/adapter/api/middleware/auth.go`\n- High-Level Purpose: This file defines an HTTP middleware for authenticating incoming requests by validating an API key provided in the `X-API-Key` header.\n- Definitions in the File:\n  - Constants:\n    - `APIKeyHeader` (string): \"X-API-Key\". Specifies the HTTP header name for the API key.\n  - Functions:\n    - `Auth(repo domain.APIKeyRepository, logger *slog.Logger) func(http.Handler) http.Handler`: Public function.\n      - Description: A middleware factory that returns an `http.Handler` function. It extracts the API key from the request header, uses the provided `APIKeyRepository` to validate it, and either allows the request to proceed or responds with an `Unauthorized` or `Internal Server Error` status.\n- Notable Patterns or Logic:\n  - HTTP Middleware pattern for request interception and processing.\n  - Dependency injection for the API key repository and logger.\n",
  "internal/adapter/pii/redactor.go": "- File Path: `internal/adapter/pii/redactor.go`\n- High-Level Purpose: This file defines a `Redactor` component responsible for identifying and replacing sensitive (PII) fields within the JSON `Metadata` of `LogEvent` objects with a placeholder.\n- Definitions in the File:\n  - Constants:\n    - `RedactedPlaceholder` (string): \"[REDACTED]\". The string used to replace redacted PII values.\n  - Classes / Structs / Interfaces:\n    - `Redactor` (struct): Manages the redaction of specified PII fields from log event metadata.\n      - Fields:\n        - `fieldsToRedact` (map[string]struct{}): A set of field names whose values should be redacted.\n        - `logger` (*slog.Logger): Structured logger instance.\n  - Functions:\n    - `NewRedactor(fields []string, logger *slog.Logger) *Redactor`: Public function.\n      - Description: Constructor for `Redactor`, initializing it with a list of field names to be redacted and a logger. It converts the list of fields into a map for efficient lookups.\n    - `(*Redactor) Redact(event *domain.LogEvent) error`: Public method.\n      - Description: Modifies the provided `LogEvent` in place. It unmarshals the `Metadata` field (expected to be JSON), iterates through the configured `fieldsToRedact`, and replaces any matching field values with `RedactedPlaceholder`. If any redaction occurs, it sets `event.PIIRedacted` to `true` and remarshals the modified metadata back into `event.Metadata`. It logs warnings or errors if JSON processing fails.\n- Notable Patterns or Logic:\n  - Data transformation/processing component.\n  - Dynamic JSON field manipulation using `encoding/json` for unmarshalling and marshalling.\n  - In-place modification of a domain object (`LogEvent`).",
  "internal/adapter/repository/postgres/apikey_repository.go": "- File Path: `internal/adapter/repository/postgres/apikey_repository.go`\n- High-Level Purpose: This file provides a PostgreSQL-backed implementation of the `domain.APIKeyRepository` interface, featuring an in-memory, time-based cache to optimize API key validation performance.\n- Definitions in the File:\n  - Classes / Structs / Interfaces:\n    - `cacheEntry` (struct): Represents a single entry in the API key cache.\n      - Fields:\n        - `isValid` (bool): Indicates if the API key is valid.\n        - `expiresAt` (time.Time): The timestamp when this cache entry expires.\n    - `APIKeyRepository` (struct): Implements `domain.APIKeyRepository` for PostgreSQL.\n      - Fields:\n        - `db` (*sql.DB): Database connection pool.\n        - `logger` (*slog.Logger): Structured logger instance.\n        - `cache` (map[string]cacheEntry): In-memory cache for API key validation results.\n        - `mu` (sync.RWMutex): Read-write mutex for thread-safe cache access.\n        - `cacheTTL` (time.Duration): Time-to-live for cache entries.\n  - Functions:\n    - `NewAPIKeyRepository(db *sql.DB, logger *slog.Logger, cacheTTL time.Duration) *APIKeyRepository`: Public function.\n      - Description: Constructor for `APIKeyRepository`, initializing it with a database connection, logger, and the desired cache TTL.\n    - `(*APIKeyRepository) IsValid(ctx context.Context, key string) (bool, error)`: Public method.\n      - Description: Checks if an API key is valid. It first attempts to retrieve the validation status from the in-memory cache. If the key is not found or the cache entry has expired, it queries the PostgreSQL database, updates the cache with the new validation status and expiration, and then returns the result. It uses a read-write mutex to ensure thread safety during cache operations.\n- Notable Patterns or Logic:\n  - Repository pattern implementation for data access.\n  - Read-through caching mechanism with a configurable time-to-live (TTL).\n  - Concurrency control using `sync.RWMutex` for safe access to the shared cache.\n  - Database interaction using `database/sql` for PostgreSQL.\n",
  "internal/domain/log.go": "- File Path: `internal/domain/log.go`\n- High-Level Purpose: This file defines the canonical data structure for a log event within the system, including fields for event details and metadata.\n- Definitions in the File:\n  - Classes / Structs / Interfaces:\n    - `LogEvent` (struct): Represents a single log event.\n      - Fields:\n        - `ID` (string): Unique identifier for the event.\n        - `ReceivedAt` (time.Time): Timestamp when the event was received by the system.\n        - `EventTime` (time.Time): Original timestamp of the event.\n        - `Source` (string): Origin of the log event (optional).\n        - `Level` (string): Log level (e.g., \"info\", \"error\") (optional).\n        - `Message` (string): The primary log message.\n        - `Metadata` (json.RawMessage): Arbitrary JSON metadata associated with the event (optional).\n        - `RawEvent` (json.RawMessage): The original raw event payload, not intended for final serialization.\n        - `PIIRedacted` (bool): Indicates if Personally Identifiable Information has been redacted (optional).\n- Notable Patterns or Logic:\n  - Domain model definition.\n  - JSON struct tags for serialization/deserialization.\n",
  "internal/domain/repository.go": "- File Path: `internal/domain/repository.go`\n- High-Level Purpose: This file defines interfaces for various data repositories, abstracting away specific storage implementations for log buffering, API key validation, and write-ahead logging.\n- Definitions in the File:\n  - Classes / Structs / Interfaces:\n    - `LogRepository` (interface): Defines methods for buffering, reading, writing, and acknowledging log events.\n      - Methods:\n        - `BufferLog(ctx context.Context, event LogEvent) error`: Public method. Adds a single log event to a durable buffer.\n        - `ReadLogBatch(ctx context.Context, group, consumer string, count int) ([]LogEvent, error)`: Public method. Reads a batch of log events from the buffer for a specific consumer group.\n        - `WriteLogBatch(ctx context.Context, events []LogEvent) error`: Public method. Writes a batch of log events to the final structured sink.\n        - `AcknowledgeLogs(ctx context.Context, group string, eventIDs ...string) error`: Public method. Marks a set of log events as successfully processed in the buffer.\n    - `APIKeyRepository` (interface): Defines methods for validating API keys.\n      - Methods:\n        - `IsValid(ctx context.Context, key string) (bool, error)`: Public method. Checks if an API key is valid and active, with an expectation for caching.\n    - `WALRepository` (interface): Defines methods for interacting with a Write-Ahead Log (WAL) for failover.\n      - Methods:\n        - `Write(ctx context.Context, event LogEvent) error`: Public method. Appends a log event to the local WAL file.\n        - `Replay(ctx context.Context, handler func(event LogEvent) error) error`: Public method. Reads events from the WAL and processes them using a provided handler function.\n        - `Truncate(ctx context.Context) error`: Public method. Removes WAL segments that have been successfully replayed.\n- Notable Patterns or Logic:\n  - Repository pattern for data access abstraction.\n  - Interface-based design for loose coupling.\n",
  "internal/pkg/config/config.go": "- File Path: `internal/pkg/config/config.go`\n- High-Level Purpose: This file defines the application's configuration structure and provides a function to load these settings from environment variables, supporting `.env` files for local development.\n- Definitions in the File:\n  - Classes / Structs / Interfaces:\n    - `Config` (struct): Holds all application configuration parameters.\n      - Fields:\n        - `LogLevel` (string): The desired logging level (e.g., \"info\", \"debug\").\n        - `MaxEventSize` (int64): Maximum allowed size for a single log event in bytes.\n        - `WALSegmentSize` (int64): Size of individual WAL segments in bytes.\n        - `WALMaxDiskSize` (int64): Maximum total disk space for the WAL in bytes.\n        - `BackpressurePolicy` (string): Defines behavior when internal buffers are full (\"block\", \"429\", \"drop\").\n        - `RedisAddr` (string): Address for the Redis instance.\n        - `PostgresURL` (string): Connection URL for the PostgreSQL database.\n        - `APIKeyCacheTTL` (time.Duration): Time-to-live for API key cache entries.\n  - Functions:\n    - `Load() (*Config, error)`: Public function.\n      - Description: Loads configuration from environment variables into a `Config` struct. It also attempts to load a `.env` file for local development purposes.\n- Notable Patterns or Logic:\n  - Configuration management using environment variables.\n  - Use of `github.com/caarlos0/env` for structured environment variable parsing.\n  - Support for `.env` files via `github.com/joho/godotenv`.\n",
  "internal/pkg/logger/logger.go": "- File Path: `internal/pkg/logger/logger.go`\n- High-Level Purpose: This file provides a utility function to create and configure a structured logger using Go's `slog` package.\n- Definitions in the File:\n  - Functions:\n    - `New(level string) *slog.Logger`: Public function.\n      - Description: Creates and returns a new `slog.Logger` instance. It configures the logger to output JSON format to standard output and sets the logging level based on the provided string (e.g., \"debug\", \"info\", \"warn\", \"error\"). Defaults to \"info\" if an unknown level is provided.\n- Notable Patterns or Logic:\n  - Centralized logger initialization.\n  - Structured logging setup using `slog`.\n"
}